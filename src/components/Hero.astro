---
// Hero section with search functionality
interface Props {
	registries: Array<{
		code: string;
		name: string;
		placeholder: string;
		extension: string;
	}>;
	defaultRegistry: {
		code: string;
		name: string;
		placeholder: string;
		extension: string;
	};
}

const { registries, defaultRegistry } = Astro.props;
---

<section class="bg-[#022545] px-6 py-20 md:py-32 lg:py-40 md:px-16 lg:px-24">
	<div class="max-w-7xl mx-auto">
		<!-- Breadcrumb -->
		<p class="text-white/70 text-base md:text-lg mb-8">Whois Maroc</p>
		
		<!-- Main Heading -->
		<h1 class="text-white text-4xl md:text-5xl lg:text-6xl xl:text-7xl font-light mb-12 leading-tight">
			Recherche d'un<br />
			domaine dans <em class="italic font-serif">le<br />registre WHOIS Maroc</em>
		</h1>

		<!-- Search Form -->
		<form 
			method="GET" 
			action="/"
			class="flex flex-col sm:flex-row gap-0 max-w-2xl" 
			role="search" 
			aria-label="Recherche de domaine"
			id="domain-search-form"
		>
			<div class="flex flex-1 bg-white rounded-t-lg sm:rounded-l-lg sm:rounded-tr-none shadow-xl">
				<label for="domain-search" class="sr-only">Chercher un domaine</label>
				<input 
					type="text" 
					id="domain-search"
					name="domain"
					required
					minlength="2"
					maxlength="63"
					placeholder={defaultRegistry.placeholder}
					data-placeholder={defaultRegistry.placeholder}
					class="flex-1 px-6 py-4 md:py-5 text-gray-700 placeholder:text-gray-400 text-base md:text-lg focus:outline-none rounded-tl-lg sm:rounded-l-lg"
					aria-label="Nom de domaine"
				/>
				<div class="relative flex items-center border-l border-gray-200">
					<select 
						id="registry-select"
						class="appearance-none px-4 py-4 md:py-5 text-gray-700 font-semibold text-base md:text-lg bg-transparent cursor-pointer hover:bg-gray-50 focus:outline-none focus:bg-gray-50 transition-colors pr-10 min-w-[100px]"
						aria-label="Sélectionner un registre de domaine"
					>
						{registries.map(registry => (
							<option value={registry.extension} data-code={registry.code} selected={registry.code === defaultRegistry.code}>
								{registry.extension}
							</option>
						))}
					</select>
					<!-- Custom dropdown arrow -->
					<div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none">
						<svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
						</svg>
					</div>
				</div>
			</div>
			<button 
				type="submit" 
				class="bg-[#00d563] hover:bg-[#00c157] text-white px-8 py-4 md:py-5 text-base md:text-lg font-semibold rounded-b-lg sm:rounded-r-lg sm:rounded-bl-none transition-all duration-200 hover:shadow-lg active:scale-[0.98] shadow-xl"
				aria-label="Rechercher le domaine"
			>
				Rechercher
			</button>
		</form>
	</div>
</section>

<script define:vars={{ registries }}>
	// Dynamic registry switching
	const registrySelect = document.getElementById('registry-select');
	const domainInput = document.getElementById('domain-search');
	const searchForm = document.getElementById('domain-search-form');

	// Function to update placeholder based on selected extension
	function updatePlaceholder(extension) {
		const selectedRegistry = registries.find(r => r.extension === extension);
		
		if (selectedRegistry && domainInput) {
			// Update input placeholder with smooth transition
			domainInput.style.opacity = '0.5';
			setTimeout(() => {
				domainInput.placeholder = selectedRegistry.placeholder;
				domainInput.style.opacity = '1';
			}, 150);
			
			// Save preference to localStorage
			localStorage.setItem('selectedExtension', extension);
		}
	}

	// Function to check if domain already has an extension
	function hasExtension(domain) {
		const allExtensions = registries.map(r => r.extension);
		return allExtensions.some(ext => domain.toLowerCase().endsWith(ext));
	}

	// Function to extract domain and extension if present
	function parseDomain(input, selectedExtension) {
		const trimmed = input.trim().toLowerCase();
		
		// Check if the input already has any valid extension
		for (const registry of registries) {
			if (trimmed.endsWith(registry.extension)) {
				// Extract domain without extension
				const domainWithoutExt = trimmed.slice(0, -registry.extension.length);
				return {
					domain: domainWithoutExt,
					extension: registry.extension
				};
			}
		}
		
		// No extension found, use the domain as-is with selected extension
		return {
			domain: trimmed,
			extension: selectedExtension
		};
	}

	// Handle form submission
	if (searchForm) {
		searchForm.addEventListener('submit', (e) => {
			e.preventDefault();
			
			const domainValue = domainInput.value.trim();
			const selectedExtension = registrySelect.value;
			
			if (!domainValue) {
				domainInput.focus();
				return;
			}
			
			// Parse the domain and determine extension
			const { domain, extension } = parseDomain(domainValue, selectedExtension);
			
			// Validate domain name (without extension)
			const validDomainPattern = /^[a-z0-9]([a-z0-9-]*[a-z0-9])?$/i;
			if (!validDomainPattern.test(domain)) {
				alert('Le nom de domaine ne peut contenir que des lettres, chiffres et tirets');
				domainInput.focus();
				return;
			}
			
			if (domain.length < 2) {
				alert('Le nom de domaine doit contenir au moins 2 caractères');
				domainInput.focus();
				return;
			}
			
			if (domain.length > 63) {
				alert('Le nom de domaine ne peut pas dépasser 63 caractères');
				domainInput.focus();
				return;
			}
			
			// Redirect with only domain parameter (no extension in URL)
			window.location.href = `/?domain=${encodeURIComponent(domain + extension)}`;
		});
	}

	// Event listener for registry selector
	if (registrySelect) {
		registrySelect.addEventListener('change', (e) => {
			updatePlaceholder(e.target.value);
		});

		// Load saved registry preference on page load
		const savedExtension = localStorage.getItem('selectedExtension');
		if (savedExtension) {
			const registryExists = registries.find(r => r.extension === savedExtension);
			if (registryExists) {
				registrySelect.value = savedExtension;
				updatePlaceholder(savedExtension);
			}
		}
	}

	// Add smooth transition style to input
	if (domainInput) {
		domainInput.style.transition = 'opacity 0.3s ease';
	}

	// Pre-fill form from URL parameters
	const urlParams = new URLSearchParams(window.location.search);
	const domainParam = urlParams.get('domain');
	
	if (domainParam && domainInput) {
		// Check if domain has extension
		const parsed = parseDomain(domainParam, registries[0].extension);
		domainInput.value = domainParam; // Show full domain with extension
		
		// Update select to match the extension if present
		if (registrySelect && parsed.extension) {
			registrySelect.value = parsed.extension;
			updatePlaceholder(parsed.extension);
		}
	}
</script>

<style>
	/* Custom styling for smooth transitions */
	input::placeholder {
		opacity: 0.6;
	}

	/* Focus states */
	input:focus,
	button:focus {
		outline: 2px solid #00d563;
		outline-offset: 2px;
	}

	/* Custom select styling */
	#registry-select {
		cursor: pointer;
	}

	#registry-select option {
		background-color: #ffffff;
		color: #374151;
		padding: 12px;
		font-weight: 600;
	}

	/* Remove default select arrow */
	#registry-select::-ms-expand {
		display: none;
	}

	/* Hover effect for search button */
	button[type="submit"] {
		transform-origin: center;
	}

	/* Responsive text sizing */
	@media (max-width: 640px) {
		h1 {
			font-size: 2rem;
		}
	}

	/* Add subtle scale effect on select focus */
	#registry-select:focus {
		outline: none;
	}

	#registry-select:active {
		transform: scale(0.98);
	}
</style>

