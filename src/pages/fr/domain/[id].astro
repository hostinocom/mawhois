---
export const prerender = false; // this page becomes SSR

import Layout from '../../../layouts/Layout.astro';
import DomainAvailable from '../../../components/sections/domain/DomainAvailable.astro';
import DomainUnavailable from '../../../components/sections/domain/DomainUnavailable.astro';
import { jwtVerify, type JWTPayload } from 'jose';
import { frDomain } from '../../../config/i18n/fr';

interface Result {
	available: boolean;
	info: string;
}

const locale = 'fr';

// Get domain from URL params
const domain = Astro.params.id;
const signature = Astro.url.searchParams.get('sig');

// Redirect to home if no domain parameter or signature
if (!domain || !signature) {
	return Astro.redirect('/fr/');
}

// Verify JWT signature and validate domain
let error = null;
let isValid = false;
let payload: JWTPayload | undefined;

try {
	const secret = import.meta.env.DOMAIN_SECRET_KEY || 'aaaaa39';
	const secretKey = new TextEncoder().encode(secret);
	
	const verificationResult = await jwtVerify(signature, secretKey, {
		algorithms: ['HS256'],
	});
	
	payload = verificationResult.payload;
	
	// Verify the domain in the token matches the URL parameter
	if (payload?.domain === domain) {
		isValid = true;
	}
} catch (error) {
	// JWT verification failed (expired, invalid signature, etc.)
	console.error('JWT verification error:', error);
	isValid = false;
}

// Redirect if signature is invalid or domain doesn't match
if (!isValid) {
	return Astro.redirect('/fr/');
}

// Fetch WHOIS data server-side (only if signature is valid)
let result: Result | null = null;

try {
	const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:4321';
	const response = await fetch(`${apiUrl}/api/whois?domain=${encodeURIComponent(domain)}`);
	result = await response.json();
} catch (error) {
	console.error('Error fetching domain:', error);
	error = frDomain.error.fetchError;
}
---

<Layout lang={locale}>
	
	{error ? (
		<div class="text-red-500">{error}</div>
	  ) : (
		result?.available ? (
		  <DomainAvailable domain={domain} translations={frDomain.DomainAvailable} />
		) : (
		  <DomainUnavailable domain={domain} info={result?.info} translations={frDomain.DomainUnavailable} />
		)
	  )}
	  
	  
	
</Layout>

